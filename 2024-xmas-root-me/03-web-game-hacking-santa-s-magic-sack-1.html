<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="robots" content="index, follow">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>XMAS root-me challenges, Generous Santa</title>
        <meta name="description" content="">
        <meta name="keywords" content="ctf, security, root-me, xmas, web, web game, generous santa, write-up">
        <meta name="author" content="Antoine Benevaut">

        <meta property="og:type" content="website">
        <meta property="og:url" content="https://www.abenevaut.dev/2024-xmas-root-me/03-web-game-hacking-santa-s-magic-sack-1.html">
        <meta property="og:title" content="XMAS root-me challenges, Generous Santa">
        <meta property="og:description" content="">
        <meta property="og:image" content="https://www.abenevaut.dev/images/abenevaut-og-sec.webp">

        <meta property="twitter:card" content="summary_large_image">
        <meta name=”twitter:creator” content=”@abenevaut”>
        <meta property="twitter:url" content="https://www.abenevaut.dev/2024-xmas-root-me/03-web-game-hacking-santa-s-magic-sack-1.html">
        <meta property="twitter:title" content="XMAS root-me challenges, Generous Santa">
        <meta property="twitter:description" content="">
        <meta property="twitter:image" content="https://www.abenevaut.dev/images/abenevaut-og-sec.webp">
        <meta property="twitter:image:alt" content="">

        <base href="/"> <!-- dev.abenevaut/abenevaut/dist/ -->

            <link rel="canonical" href="//index.html" />
    <script>
      window.article = '""'
      window.writeup = "<a href=\"#write-up-santas-magic-sack\"><h1 id='write-up-santas-magic-sack'>Write-up Santa's Magic Sack<\/h1><\/a>\n<p>3 d\u00e9cembre 2024, XMAS \ud83c\udf85 root-me d\u00e9marre avec une \u00e9preuve web &quot;Santa's Magic Sack&quot;, on attaque!<\/p>\n<blockquote>\n<p>Santa has developed a web game where you have to catch presents, and as luck would have it, he's come out on top of the scoreboard. Can you beat him?<\/p>\n<\/blockquote>\n<p>Rendez-vous sur <a href=\"https:\/\/day3.challenges.xmas.root-me.org\">l'\u00e9preuve<\/a><\/p>\n<p>Long story short, la page d'accueil nous demande de renseigner un speudo et nous donne quelques instructions sur le jeu auquel on va jouer.\nLe jeu lui-m\u00eame est un classique, on d\u00e9place une hotte et on essaie de r\u00e9cup\u00e9rer des cadeaux qui tombent du ciel.\nIl faut en r\u00e9cup\u00e9rer le plus possible pour gagner et cela sur 20secondes. \u00c0 chaque cadeau r\u00e9cup\u00e9r\u00e9, on gagne des points.\nUne fois le temps \u00e9coul\u00e9, on voit notre score, un message qui nous indique notre score puis on voit la scoreboard. Et on recommence...<\/p>\n<p>Le but est de faire le meilleur score et franchement vu le rythme du jeux pour battre le premier \u00e0 133337, faut s'accrocher.<\/p>\n<p>On essaie de faire le malin, que se passe-t-il si on r\u00e9duit la largeur de la fen\u00eatre ? On double \u00e0 peu pr\u00e8s notre score mais ce n'est pas suffisant.<\/p>\n<p>Qu'est-ce qu'il y a sous le capot? On ouvre les outils de d\u00e9veloppement et on regarde les requ\u00eates qui sont faites.\nOn voit une requ\u00eate POST qui est faite \u00e0 la fin du jeu vers le endpoint <code>\/api\/scores<\/code>, on regarde les param\u00e8tres envoy\u00e9s et on voit un param\u00e8tre <code>data<\/code> qui est envoy\u00e9.\n<code>data<\/code> contient une string encod\u00e9 en base64, on la d\u00e9code et on voit un objet s\u00e9rialis\u00e9, il doit contenir notre score, c'est s\u00fbr!<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-game-hacking-santa-s-magic-sack-1-intercept_first_post.png\" alt=\"\" \/><\/p>\n<p>\u00c0 ce moment l\u00e0 de mon investigation, j'ai perdu un peu de temps \u00e0 vouloir d\u00e9s\u00e9rialiser l'objet, et je me suis rendu compte que c'\u00e9tait inutile.<\/p>\n<p>Quand on fouille un peu les sources du site via la console web, on y trouve un seul fichier javascript <code>index-&lt;HASH&gt;.js<\/code>.\nOn porte nos recherche sur le endpoint <code>\/api\/scores<\/code> et on trouve, localis\u00e9 proche les unes des autres, des fonctions qui portent sur l'envoie de la requ\u00eate POST et sur l'encodage notre objet.<\/p>\n<p>On aura m\u00eame du mal \u00e0 passer \u00e0 c\u00f4t\u00e9 de la constante <code>S4NT4_S3CR3T_K3Y_T0_ENCRYPT_DATA<\/code> qui est certainement la clef de chiffrement utilis\u00e9e.<\/p>\n<pre><code class=\"language-javascript\">var Md = hf.exports;\nconst gf = Rf(Md)\n, Ud = &quot;S4NT4_S3CR3T_K3Y_T0_ENCRYPT_DATA&quot;;\nfunction Wd(e) {\n  const t = JSON.stringify(e);\n  return gf.AES.encrypt(t, Ud).toString()\n}\n  function $d(e, t) {\n  const r = Math.floor(Math.random() * 9) + 1\n  , n = `${e}-${t}-${r}`;\n  return {\nchecksum: gf.SHA256(n).toString(),\nsalt: r\n}\n}\n  async function Vd(e, t) {\nconst {checksum: r, salt: n} = $d(e, t)\n                   , l = Wd({\n                   playerName: e,\n                   score: t,\n                   checksum: r,\n                   salt: n\n});\n  try {\n  return await (await fetch(&quot;\/api\/scores&quot;, {\nmethod: &quot;POST&quot;,\nheaders: {\n  &quot;Content-Type&quot;: &quot;application\/json&quot;\n},\nbody: JSON.stringify({\n  data: l\n})\n})).json()\n} catch (i) {\n  return console.error(&quot;Error submitting score:&quot;, i),\n  {\n    success: !1\n  }\n}\n}\n<\/code><\/pre>\n<p>Je prends deux\/trois minutes pour souffler dans un sac en papier pour \u00e9vacuer la frustration de devoir faire du reverse engineering sur un jeu de No\u00ebl, et on reprend.<\/p>\n<p>Ou est-ce que je peux intercepter le score avant qu'il soit encod\u00e9, envoy\u00e9 et utilis\u00e9 par le backend ?<\/p>\n<p>On poursuit l'analyse des sources et on finit par trouver ce bout de code:<\/p>\n<pre><code class=\"language-javascript\">  const f = async () =&gt; {\n    p.current = !0,\n    h.current &amp;&amp; cancelAnimationFrame(h.current);\n    const v = s.current;\n    m(!0);\n    try {\n      const C = await Vd(e, v);\n      C.isNewRecord &amp;&amp; C.flag &amp;&amp; y(C.flag)\n    } catch (C) {\n      console.error(&quot;Error submitting score:&quot;, C)\n    }\n    setTimeout( () =&gt; {\n    m(!1),\n    t(v)\n  }\n  , 5e3)\n};\n<\/code><\/pre>\n<p>Si on poursuit l'analyse, on voit que la fonction <code>Vd<\/code> finit par aller jusque l'encodage du score.\n<code>Vd(e, v)<\/code> prend deux param\u00e8tres et la variable <code>v<\/code> est initialis\u00e9e juste au dessus, qu'y a-t-il dedans ?<\/p>\n<p>\ud83c\udf85Hohoho! On trouve la m\u00eame valeur que notre score!<\/p>\n<p>On va pouvoir tenter de poser un breakpoint et de change la valeur <code>s.current<\/code>.<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-game-hacking-santa-s-magic-sack-1-change_value.png\" alt=\"\" \/><\/p>\n<p>On relance l'application avec notre score modifi\u00e9, et c'est flag\u00e9!<\/p>\n<p>Le flag est un peu chiant \u00e0 copier\/coller via la modal qui s'ouvre, il est possible de le r\u00e9cup\u00e9rer via la tabulation &quot;Elements&quot; ou &quot;R\u00e9seau&quot; de la console web.<\/p>\n<p>Si comme moi, vous n'avez pas beaucoup exp\u00e9rimentez <a href=\"https:\/\/portswigger.net\/burp\">Burp Suite<\/a>, recommenc\u00e9 l'\u00e9preuve et intercept\u00e9 la requ\u00eate POST pour r\u00e9cup\u00e9rer le flag.<\/p>\n<p><img src=\"images\/ctf-2024-rootme-xmas\/web-game-hacking-santa-s-magic-sack-1-flag.png\" alt=\"\" \/><\/p>\n<p>Cr\u00e9dits du challenge <a href=\"https:\/\/x.com\/rootme_org\/status\/1863902222846669194\">root-me.org<\/a> et son auteur <a href=\"https:\/\/x.com\/Elweth_\">Elweth<\/a><\/p>\n<p><a href=\"2024-xmas-root-me.html\">Sommaire &gt;<\/a> - <a href=\"2024-xmas-root-me\/04-misc-build-and-drustroy-1.html\">Challenge suivant &gt;<\/a><\/p>\n"
    </script>
    <script type="module" src="assets/Writeup.js"></script>

        <link rel="preconnect" href="https://fonts.bunny.net">
        <link rel="stylesheet" href="assets/app.css">
        <link rel="shortcut icon" href="assets/app-icon.webp" type="image/webp">
    </head>
    <body class="font-sans antialiased">
        <div id="root"></div>
    </body>
</html>
